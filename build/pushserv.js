/*! iweb-push-server - v0.1.0 - 2015-10-18
* Copyright (c) 2015 ; Licensed  */
function notificationIsNotSent(scheduledoc,email,callback){db.users.find({email:email},function(err,doc){err?(console.log(err),sendPush.admin("pushserv.js",err)):-1==doc[0].already_sent.indexOf(scheduledoc.id)&&db.users.update({email:email},{$push:{already_sent:scheduledoc.id}},function(){console.log("ADD",scheduledoc.id,"to",email),callback(scheduledoc.subjects,scheduledoc.teachers,scheduledoc.changeDescription,convertToDay(scheduledoc.start))})})}function retrieveLeerlingnum(token,callback){var url="https://scmoost.zportal.nl/api/v2/users/~me?access_token="+token;request(url,function(err,response,body){if(!err&200==response.statusCode){var leerlingnum=JSON.parse(response.body).response.data[0].code;callback(null,leerlingnum)}else callback(err,null),sendPush.admin("pushserv.js",err)})}function convertToDay(seconds){var day=new Date(1e3*seconds).getDay();return 1==day?"maandag":2==day?"dinsdag":3==day?"woensdag":4==day?"donderdag":5==day?"vrijdag":day}function retrieveSchedule(email,leerlingnum,token){var startTime=(Math.round((new Date).getTime()/1e3),1444626e3),endTime=strtotime("next saturday",startTime),roosterurl="http://lschoonheid.leerik.nl/beta/?id="+leerlingnum,apiurl="https://scmoost.zportal.nl/api/v2/appointments?user=~me&start="+startTime+"&end="+endTime+"&access_token="+token+"&valid="+!0;request(apiurl,function(err,response,body){if(err||200!=response.statusCode)console.log("Error occured: "+err),sendPush.admin("pushserv.js",err);else{console.log("Succesful request");for(var data=JSON.parse(body).response.data,i=0;i<data.length;i++)data[i].cancelled===!0?notificationIsNotSent(data[i],email,function(les,leraar,omschrijving,dag){var title=les+" op "+dag+" is vervallen!",body="Les vervallen!";sendPush.user(email,title,body,roosterurl)}):data[i].modified===!0&&notificationIsNotSent(data[i],email,function(les,leraar,omschrijving,dag){var title="Wijziging voor "+les+" op "+dag,body=omschrijving;sendPush.user(email,title,body,roosterurl)})}})}var request=require("request"),mongojs=require("mongojs"),exchangeAppcode=require("./exchangeAppcode.js"),strtotime=require("./strtotime.js"),sendPush=require("./sendPush.js"),db=mongojs("userdata",["users"]);module.exports=function(interval){console.log("Push server started"),setInterval(function(){db.users.find({first_time:0},function(err,docs){if(err)console.log(err),sendPush.admin("pushserv.js",err);else for(var i=0;i<docs.length;i++){var email=docs[i].email,token=docs[i].token;retrieveLeerlingnum(token,function(err,leerlingnum){retrieveSchedule(email,leerlingnum,token)})}})},1e3*interval)};