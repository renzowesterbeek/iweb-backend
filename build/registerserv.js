/*! iweb-push-server - v1.0.0 - 2016-05-16
* Copyright (c) 2016 ; Licensed  */
function insertDoc(email,token,callback){db.users.insert({email:email,token:token,already_sent:[]},callback)}function emailExists(email,callback){db.users.find({email:email},function(err,doc){err?(console.log(err),sendPush.admin("registerserv.js",err),db.close()):callback(0===doc.length?0:1)})}var express=require("express"),app=express(),bodyParser=require("body-parser"),mongojs=require("mongojs"),db=mongojs("userdata",["users"]),exchangeAppcode=require("./exchangeAppcode.js"),sendPush=require("./sendPush.js");module.exports=function(){app.use(bodyParser.urlencoded({extended:!0})),app.post("/register",function(req,res){var appcode=req.body.appcode,email=req.body.email;console.log("REGISTRATION DATA:",email,appcode);var redirectURL="http://localhost/iweb-website/dist/";emailExists(email,function(result){0===result?exchangeAppcode(appcode,function(err,token){err?(console.log("ERROR:",err),res.redirect(redirectURL+"?m="+err)):insertDoc(email,token,function(){console.log("Inserted"),sendPush.user(email,"Zermelo notificaties","Je ontvangt vanaf nu notificaties voor je rooster!","http://renzo.westerbeek.us/rooster"),db.close(),res.redirect(redirectURL+"?m=Je%20bent%20geregistreerd!")})}):res.redirect(redirectURL+"?m="+email+" is al geregistreerd.&appcode="+appcode)})});app.listen(3e3,function(){console.log("Registration server started on port 3000")})};